#!/bin/bash

VERSION=2.039

umask 022

TOP=$PWD
VERBOSE=0

TMP="${TMPDIR:-/tmp}/MailBox"

if [ -d $TMP ] || mkdir $TMP
then :
else echo "Cannot create $TMP: $!" >&2
     exit 1
fi

SITE=/home/markov/shared/perl/public_html/mailbox

open_up()
{   DIR="$1"
    echo "opening $DIR"
    [ -d $DIR ] || exit $?

    find $DIR         -exec chmod a+r {} \;
    find $DIR -type d -exec chmod a+x {} \;
}


echo ">>> Producing version $VERSION"
[ -d "$TMP/tests" ]   || mkdir "$TMP/tests";

echo ">>> Create pod and html"
rm -rf $SITE/html
cp -r $TOP/html $SITE

make_doc $TMP $VERSION $VERBOSE || exit $?

cd $TMP               || exit $?
find Mail -name \*.pod >>MANIFEST
sort -u MANIFEST >x && mv x MANIFEST

echo ">>> Run tests"
perl Makefile.PL      || exit $?
chmod a+x test.pl tests/*/*.t
make test             || exit $?


echo -n "Continue with distribution? [n/y/pre] "
read CONT
case "$CONT" in
y*) ;;

p*) PRE="-pre";;

*)  echo ">>> No distribution created"
    exit 0;;
esac

echo ">>> HTML to website"

open_up  $SITE/html
cd $SITE/html
tar -cf  $SITE/html/html-current.tar *
gzip -9f $SITE/html/html-current.tar
(cd $SITE/html; ls -lh html-current.tar.gz)


echo ">>> Make dist"
cd $TMP
DIST="Mail-Box-$VERSION.tar.gz"
rm -f $DIST
make dist >/dev/null

if [ -n "$PRE" ]
then PREDIST="Mail-Box-$VERSION-pre.tar.gz"
     mv $DIST $PREDIST
     DIST="$PREDIST"
fi

(cd $TMP; ls -lh $DIST)

[ -d $SITE/source ] || mkdir $SITE/source
cp $TMP/$DIST $SITE/source/

[ -z "$PRE" ] && ln -sf $DIST $SITE/source/source-current.tar.gz
open_up $SITE/source

# Create simple index of all releases

INDEX=$SITE/source/index.html
echo >$INDEX <<'page_head'
<HTML>
<HEAD><TITLE>Older sources of Mail::Box</TITLE></HEAD>
<BODY BGCOLOR=white>
page_head

for f in $(cd $SITE/source; ls *gz)
do echo "<A HREF=\"$f\">$f</A><BR>" >>$INDEX
done

echo >>$INDEX <<'page_tail'
</BODY></HTML>
page_tail

echo ">>> Make raw"

cd $TOP
[ -d $SITE/raw ] || mkdir $SITE/raw
RAW=Mail-Box-raw.$VERSION.cpio
cat MANIFEST MANIFEST.raw | cpio -oca >$SITE/raw/$RAW
bzip2 -9f $SITE/raw/$RAW

ln -sf $RAW.bz2 $SITE/raw/raw-current.cpio.bz2
(cd $SITE/raw; ls -lh $RAW.bz2)
open_up $SITE/raw

echo ">>> Ready"
